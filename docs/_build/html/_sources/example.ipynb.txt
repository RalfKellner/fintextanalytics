{
    "cells": [
        {
            "attachments": {},
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "# Example usage\n"
            ]
        },
        {
            "attachments": {},
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "## Preprocess some text\n",
                "\n",
                "The package has a simple function for preprocessing text. The function uses a combination of preprocessing function from the [gensim](https://radimrehurek.com/gensim/) package."
            ]
        },
        {
            "cell_type": "code",
            "execution_count": 2,
            "metadata": {},
            "outputs": [
                {
                    "name": "stdout",
                    "output_type": "stream",
                    "text": [
                        ">Item 1A.    Risk Factors The Company’s business, reputation, results of operations, financial condition and stock price can be affected by a number of factors, whether currently known or unknown, inc\n",
                        "['item', 'risk', 'factors', 'the', 'company', 'business', 'reputation', 'results', 'of', 'operations', 'financial', 'condition', 'and', 'stock', 'price', 'can', 'be', 'affected', 'by', 'number', 'of', 'factors', 'whether', 'currently', 'known']\n"
                    ]
                }
            ],
            "source": [
                "from fintextanalytics.utils import load_example_text, text_preprocessor\n",
                "\n",
                "# this is a 1a item from a 10K report of Apple\n",
                "text = load_example_text()\n",
                "# raw text\n",
                "print(text[:200])\n",
                "# the preprocessing function returns a list of tokens\n",
                "print(text_preprocessor(text)[:25])"
            ]
        },
        {
            "attachments": {},
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "## Split a document into preprocessed sentences"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": 8,
            "metadata": {},
            "outputs": [
                {
                    "name": "stdout",
                    "output_type": "stream",
                    "text": [
                        "                                            raw_text  ... use_doc\n",
                        "0                                          >Item 1A.  ...   False\n",
                        "1  Risk Factors The Company’s business, reputatio...  ...    True\n",
                        "2  When any one or more of these risks materializ...  ...    True\n",
                        "3  Because of the following factors, as well as o...  ...    True\n",
                        "4  This discussion of risk factors contains forwa...  ...   False\n",
                        "\n",
                        "[5 rows x 3 columns]\n",
                        "                                            raw_text  ... company\n",
                        "0                                          >Item 1A.  ...   Apple\n",
                        "1  Risk Factors The Company’s business, reputatio...  ...   Apple\n",
                        "2  When any one or more of these risks materializ...  ...   Apple\n",
                        "3  Because of the following factors, as well as o...  ...   Apple\n",
                        "4  This discussion of risk factors contains forwa...  ...   Apple\n",
                        "\n",
                        "[5 rows x 4 columns]\n"
                    ]
                }
            ],
            "source": [
                "from fintextanalytics.utils import load_example_text, report2sentences\n",
                "\n",
                "# this is a 1a item from a 10K report of Apple\n",
                "text = load_example_text()\n",
                "\n",
                "# preprocessed sentence dataframe\n",
                "print(report2sentences(text).head())\n",
                "\n",
                "# you can also add metadata which is added columnwise\n",
                "print(report2sentences(text, company = 'Apple').head())"
            ]
        },
        {
            "attachments": {},
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "## Load example reports and preprocess them for analysis"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": 1,
            "metadata": {},
            "outputs": [
                {
                    "name": "stdout",
                    "output_type": "stream",
                    "text": [
                        "                                            raw_text  \\\n",
                        "1  Risk Factors    Because of\\nthe following fact...   \n",
                        "3  The Companys operations and performance depen...   \n",
                        "4  Uncertainty about global economic conditions p...   \n",
                        "5  For example, the\\ncontinuing sovereign debt cr...   \n",
                        "6  These worldwide and regional economic conditio...   \n",
                        "\n",
                        "                                           prep_text  use_doc    item  \\\n",
                        "1  risk,factors,because,of,the,following,factors,...     True  item1a   \n",
                        "3  the,company,operations,and,performance,depend,...     True  item1a   \n",
                        "4  uncertainty,about,global,economic,conditions,p...     True  item1a   \n",
                        "5  for,example,the,continuing,sovereign,debt,cris...     True  item1a   \n",
                        "6  these,worldwide,and,regional,economic,conditio...     True  item1a   \n",
                        "\n",
                        "                    accDate company  \n",
                        "1  2012-10-31T17:07:19.000Z   Apple  \n",
                        "3  2012-10-31T17:07:19.000Z   Apple  \n",
                        "4  2012-10-31T17:07:19.000Z   Apple  \n",
                        "5  2012-10-31T17:07:19.000Z   Apple  \n",
                        "6  2012-10-31T17:07:19.000Z   Apple  \n"
                    ]
                }
            ],
            "source": [
                "from fintextanalytics.utils import load_example_reports, report2sentences\n",
                "import pandas as pd\n",
                "\n",
                "# load items from Apple's 10K reports since 2012\n",
                "apple_10k_items = load_example_reports()\n",
                "\n",
                "# use the report2sentences function to iterate through each item, split into sentences and preprocess text\n",
                "initialized = False\n",
                "for idx, row in apple_10k_items.iterrows():\n",
                "    if initialized:\n",
                "        report_sentences_prep_tmp = report2sentences(row['text'], idx_start=report_sentences_preprocessed.index[-1] + 1, item = row['item'], accDate = row['accDate'], company = row['company'])\n",
                "        report_sentences_preprocessed = pd.concat((report_sentences_preprocessed, report_sentences_prep_tmp), axis = 0)\n",
                "    else:\n",
                "        report_sentences_prep_tmp = report2sentences(row['text'], item = row['item'], accDate = row['accDate'], company = row['company'])\n",
                "        report_sentences_preprocessed = report_sentences_prep_tmp.copy()\n",
                "        initialized = True\n",
                "\n",
                "# a mapping between docid (sentences which are used for search) and raw id\n",
                "docid2idx = dict()\n",
                "for i, idx in enumerate(report_sentences_preprocessed[report_sentences_preprocessed.use_doc].index):\n",
                "    docid2idx[i] = idx\n",
                "\n",
                "print(report_sentences_preprocessed[report_sentences_preprocessed.use_doc].head())"
            ]
        },
        {
            "attachments": {},
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "## Search for documents whose meaning is close to the meaning of certain words"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": 2,
            "metadata": {},
            "outputs": [
                {
                    "name": "stdout",
                    "output_type": "stream",
                    "text": [
                        "In sum 49 words from the default word lists could not be found in the Word2Vec vocabulary. These words are deleted from the word list:\n",
                        "{'honesty', 'stepchildren', 'grandchildren', 'grandparent', 'stepparents', 'marriage', 'parachutes', 'spousal', 'ethnicities', 'gay', 'vestsballot', 'minorities', 'donating', 'humanity', 'donates', 'discriminated', 'eeo', 'nephews', 'genders', 'lesbian', 'nieces', 'bisexual', 'siblings', 'lgbt', 'ruggie', 'vacancyappreciation', 'grandparents', 'householding', 'eicc', 'ballots', 'interlocks', 'proponent', 'educates', 'cobc', 'ungc', 'childbirth', 'homosexual', 'ethnicity', 'motivates', 'lesbians', 'webpage', 'ethic', 'ethnically', 'transgender', 'lobbyist', 'nondiscrimination', 'ilo', 'perquisites', 'gays'}\n",
                        "Vectors seem not have unit length...the vectors have been l2-normalized.\n",
                        "The context word for the following documents is: clean\n",
                        "The corresponing sentence with the highest similarity is:\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Component defects could make the Company’s products unsafe and create a risk of environmental or property damage and personal injury.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "\n",
                        "The context word for the following documents is: environmental\n",
                        "The corresponing sentence with the highest similarity is:\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "The Company’s global operations are subject to complex and changing laws and regulations on subjects, including antitrust; privacy, data security and data localization; consumer protection; advertising, sales, billing and e-commerce; product liability; intellectual property ownership and infringement; digital platforms; Internet, telecommunications, and mobile communications; media, television, film and digital content; availability of third-party software applications and services; labor and employment; anticorruption; import, export and trade; foreign exchange controls and cash repatriation restrictions; anti–money laundering; foreign ownership and investment; tax; and environmental, health and safety, including electronic waste, recycling, and climate change.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "\n",
                        "The context word for the following documents is: epa\n",
                        "The corresponing sentence with the highest similarity is:\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Many governments, regulators, investors, employees, customers and other stakeholders are increasingly focused on environmental, social and governance considerations relating to businesses, including climate change and greenhouse gas emissions, human and civil rights, and diversity, equity and inclusion.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "\n",
                        "The context word for the following documents is: sustainability\n",
                        "The corresponing sentence with the highest similarity is:\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Many governments, regulators, investors, employees, customers and other stakeholders are increasingly focused on environmental, social and governance considerations relating to businesses, including climate change and greenhouse gas emissions, human and civil rights, and diversity, equity and inclusion.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "\n",
                        "The context word for the following documents is: climate\n",
                        "The corresponing sentence with the highest similarity is:\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Global climate change is resulting in certain types of natural disasters occurring more frequently or with more intense effects.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "\n"
                    ]
                }
            ],
            "source": [
                "from fintextanalytics.embeddingmodels import EmbeddingAnalyzer\n",
                "\n",
                "embed_analyzer = EmbeddingAnalyzer()\n",
                "\n",
                "# get the preprocessed text from all documents we want to use\n",
                "docs = report_sentences_preprocessed[report_sentences_preprocessed.use_doc].prep_text\n",
                "# use the embed_analzyer doc2vec model to infer document vectors for each document\n",
                "doc_vecs = [embed_analyzer.doc_model.infer_vector(doc.split(',')) for doc in docs]\n",
                "\n",
                "# the first data frame contains a word and its closest documents, the second includes corresponding cosine similarities\n",
                "topn_docs, topn_doc_scores = embed_analyzer.find_close_docs_to_words(doc_vecs, wordlist = 'ewords')\n",
                "\n",
                "# let us take a look at the closest document for the first five words\n",
                "for word, row in topn_docs.head().iterrows():\n",
                "    print(f'The context word for the following documents is: {word}')\n",
                "    original_id = docid2idx[row[0]]\n",
                "    print('The corresponing sentence with the highest similarity is:')\n",
                "    print('-'*100)\n",
                "    print(report_sentences_preprocessed.loc[original_id].raw_text)\n",
                "    print('-'*100)\n",
                "    print('')"
            ]
        },
        {
            "attachments": {},
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "Let us further add more context by printing the sentence before and after the relevant document"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": 3,
            "metadata": {},
            "outputs": [
                {
                    "name": "stdout",
                    "output_type": "stream",
                    "text": [
                        "The context word for the following documents is: clean\n",
                        "The corresponing paragraph with the relevant sentence in the middle is:\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Defects can also exist in components and products the Company purchases from third parties.\n",
                        "Component defects could make the Company’s products unsafe and create a risk of environmental or property damage and personal injury.\n",
                        "These risks may increase as the Company’s products are introduced into specialized applications, including health.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "\n",
                        "The context word for the following documents is: environmental\n",
                        "The corresponing paragraph with the relevant sentence in the middle is:\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "The Company is subject to complex and changing laws and regulations worldwide, which exposes the Company to potential liabilities, increased costs and other adverse effects on the Company’s business.\n",
                        "The Company’s global operations are subject to complex and changing laws and regulations on subjects, including antitrust; privacy, data security and data localization; consumer protection; advertising, sales, billing and e-commerce; product liability; intellectual property ownership and infringement; digital platforms; Internet, telecommunications, and mobile communications; media, television, film and digital content; availability of third-party software applications and services; labor and employment; anticorruption; import, export and trade; foreign exchange controls and cash repatriation restrictions; anti–money laundering; foreign ownership and investment; tax; and environmental, health and safety, including electronic waste, recycling, and climate change.\n",
                        "Compliance with these laws and regulations is onerous and expensive, increasing the cost of conducting the Company’s global operations.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "\n",
                        "The context word for the following documents is: epa\n",
                        "The corresponing paragraph with the relevant sentence in the middle is:\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Expectations relating to environmental, social and governance considerations expose the Company to potential liabilities, increased costs, reputational harm, and other adverse effects on the Company’s business.\n",
                        "Many governments, regulators, investors, employees, customers and other stakeholders are increasingly focused on environmental, social and governance considerations relating to businesses, including climate change and greenhouse gas emissions, human and civil rights, and diversity, equity and inclusion.\n",
                        "In addition, the Company makes statements about its environmental, social and governance goals and initiatives through its environmental, social and governance report, its other non-financial reports, information provided on its website, press statements and other communications.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "\n",
                        "The context word for the following documents is: sustainability\n",
                        "The corresponing paragraph with the relevant sentence in the middle is:\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Expectations relating to environmental, social and governance considerations expose the Company to potential liabilities, increased costs, reputational harm, and other adverse effects on the Company’s business.\n",
                        "Many governments, regulators, investors, employees, customers and other stakeholders are increasingly focused on environmental, social and governance considerations relating to businesses, including climate change and greenhouse gas emissions, human and civil rights, and diversity, equity and inclusion.\n",
                        "In addition, the Company makes statements about its environmental, social and governance goals and initiatives through its environmental, social and governance report, its other non-financial reports, information provided on its website, press statements and other communications.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "\n",
                        "The context word for the following documents is: climate\n",
                        "The corresponing paragraph with the relevant sentence in the middle is:\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "In addition, such operations and facilities are subject to the risk of interruption by fire, power shortages, nuclear power plant accidents and other industrial accidents, terrorist attacks and other hostile acts, ransomware and other cybersecurity attacks, labor disputes, public health issues, including pandemics such as the COVID-19 pandemic, and other events beyond the Company’s control.\n",
                        "Global climate change is resulting in certain types of natural disasters occurring more frequently or with more intense effects.\n",
                        "Such events can make it difficult or impossible for the Company to manufacture and deliver products to its customers, create delays and inefficiencies in the Company’s supply and manufacturing chain, and result in slowdowns and outages to the Company’s service offerings.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "\n"
                    ]
                }
            ],
            "source": [
                "# let us further add the senctence before and the sentence after\n",
                "for word, row in topn_docs.head().iterrows():\n",
                "    print(f'The context word for the following documents is: {word}')\n",
                "    original_id = docid2idx[row[0]]\n",
                "    print('The corresponing paragraph with the relevant sentence in the middle is:')\n",
                "    print('-'*100)\n",
                "    print(report_sentences_preprocessed.loc[original_id-1].raw_text)\n",
                "    print(report_sentences_preprocessed.loc[original_id].raw_text)\n",
                "    print(report_sentences_preprocessed.loc[original_id+1].raw_text)\n",
                "    print('-'*100)\n",
                "    print('')"
            ]
        },
        {
            "attachments": {},
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "## Find word with similar meaning or context"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": 61,
            "metadata": {},
            "outputs": [
                {
                    "name": "stdout",
                    "output_type": "stream",
                    "text": [
                        "                       0        1      2            3          4\n",
                        "environmental  pollution  cleanup  clean  remediation  hazardous\n",
                        "                      0         1         2         3         4\n",
                        "environmental  0.829885  0.827046  0.812441  0.806115  0.767096\n"
                    ]
                }
            ],
            "source": [
                "sim_words, sim_word_scores = embed_analyzer.most_similar_words(['environmental'])\n",
                "print(sim_words)\n",
                "print(sim_word_scores)"
            ]
        },
        {
            "attachments": {},
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "## Search for words whose meaning is close to documents"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": 4,
            "metadata": {},
            "outputs": [
                {
                    "name": "stdout",
                    "output_type": "stream",
                    "text": [
                        "Vectors seem not have unit length...the vectors have been l2-normalized.\n",
                        "The following paragraphs are close to the meaning for the word environmental: \n",
                        "\n",
                        "Date of the report: 2012-10-31T17:07:19.000Z\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "These laws continue to develop and may be inconsistent from\n",
                        "jurisdiction to jurisdiction.\n",
                        "Complying with emerging and changing international requirements may cause the Company to incur substantial costs or require the Company to change its business practices.\n",
                        "Noncompliance could result in penalties or\n",
                        "significant legal liability.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Date of the report: 2019-10-30T18:12:36.000Z\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "These laws continue to develop and may be inconsistent from jurisdiction to jurisdiction.\n",
                        "Complying with emerging and changing international requirements may cause the Company to incur substantial costs or require the Company to change its business practices.\n",
                        "Noncompliance could result in significant penalties or legal liability.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Date of the report: 2020-10-29T18:06:25.000Z\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "These laws continue to develop and may be inconsistent from jurisdiction to jurisdiction.\n",
                        "Complying with emerging and changing international requirements may cause the Company to incur substantial costs or require the Company to change its business practices.\n",
                        "Noncompliance could result in significant penalties or legal liability.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Date of the report: 2022-10-27T18:01:14.000Z\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Regulatory changes and other actions that materially adversely affect the Company’s business may be announced with little or no advance notice and the Company may not be able to effectively mitigate all adverse impacts from such measures.\n",
                        "For example, the Company is subject to changing regulations relating to the export and import of its products.\n",
                        "Although the Company has programs, policies and procedures in place that are designed to satisfy regulatory requirements, there can be no assurance that such policies and procedures will be effective in preventing a violation or a claim of a violation.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Date of the report: 2022-10-27T18:01:14.000Z\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "These laws continue to develop and may be inconsistent from jurisdiction to jurisdiction.\n",
                        "Complying with emerging and changing requirements causes the Company to incur substantial costs and has required and may in the future require the Company to change its business practices.\n",
                        "Noncompliance could result in significant penalties or legal liability.\n",
                        "----------------------------------------------------------------------------------------------------\n"
                    ]
                }
            ],
            "source": [
                "topn_words, topn_word_scores = embed_analyzer.find_close_words_to_docs(doc_vecs)\n",
                "\n",
                "word_of_interest = 'environmental'\n",
                "\n",
                "print(f'The following paragraphs are close to the meaning for the word {word_of_interest}: \\n')\n",
                "for idx in topn_words[topn_words.loc[:, 0] == word_of_interest].index:\n",
                "    original_id = docid2idx[idx]\n",
                "    print(f'Date of the report: {report_sentences_preprocessed.loc[original_id].accDate}')\n",
                "    print('-'*100)\n",
                "    print(report_sentences_preprocessed.loc[original_id-1].raw_text)\n",
                "    print(report_sentences_preprocessed.loc[original_id].raw_text)\n",
                "    print(report_sentences_preprocessed.loc[original_id+1].raw_text)\n",
                "    print('-'*100)"
            ]
        },
        {
            "attachments": {},
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "## Creating topics according to the top2vec model idea"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": 4,
            "metadata": {},
            "outputs": [
                {
                    "name": "stdout",
                    "output_type": "stream",
                    "text": [
                        "Vectors seem not have unit length...the vectors have been l2-normalized.\n",
                        "Starting to train the dimensionality reduction model...\n",
                        "Umap model for dimensionality reduction has been trained!\n",
                        "\n",
                        "Starting to train the clustering model...\n",
                        "HDBSCAN model for clustering has been trained!\n",
                        "\n",
                        "Creating topic vectors...\n",
                        "Creating topic vectors finished! 17 topics have been found.\n",
                        "Creating a reduced topic model...\n",
                        "The number of topics has been reduced from 17 to 14.\n",
                        "Topic reduction is finished, the number of reduced topics is 14\n",
                        "\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Top 10 words of topic number 1:\n",
                        "['warranty' 'ppsa' 'workmanship' 'overstocked' 'microinverters' 'inox'\n",
                        " 'foundry' 'bos' 'overpaid' 'warranties']\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Top 10 words of topic number 2:\n",
                        "['asr' 'repurchased' 'repurchase' 'mlv' 'wpz' 'lpc' 'buyback' 'vwap'\n",
                        " 'jefferies' 'aspire']\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "...\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Top 10 words of topic number 17:\n",
                        "['itunes' 'apple' 'iphone' 'android' 'google' 'app' 'downloadable' 'ipad'\n",
                        " 'ios' 'downloaded']\n",
                        "----------------------------------------------------------------------------------------------------\n"
                    ]
                }
            ],
            "source": [
                "embed_analyzer.fit_topic_model(doc_vecs)\n",
                "print('')\n",
                "print('-'*100)\n",
                "print('Top 10 words of topic number 1:')\n",
                "print(embed_analyzer.topic_words[0][:10])\n",
                "print('-'*100)\n",
                "print('Top 10 words of topic number 2:')\n",
                "print(embed_analyzer.topic_words[1][:10])\n",
                "print('-'*100)\n",
                "print('...')\n",
                "print('-'*100)\n",
                "print(f'Top 10 words of topic number {len(embed_analyzer.topic_words)}:')\n",
                "print(embed_analyzer.topic_words[-1][:10])\n",
                "print('-'*100)"
            ]
        },
        {
            "attachments": {},
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "## Find topics which are close to the meaning of words"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": 6,
            "metadata": {},
            "outputs": [
                {
                    "name": "stdout",
                    "output_type": "stream",
                    "text": [
                        "                 0  1   2\n",
                        "clean            9  2  16\n",
                        "environmental   13  8   9\n",
                        "epa             12  9   2\n",
                        "sustainability   8  9   6\n",
                        "climate          6  8   2\n",
                        "                       0         1         2\n",
                        "clean           0.063409  0.036895  0.027610\n",
                        "environmental   0.152109  0.138078  0.103929\n",
                        "epa             0.021987  0.016028  0.007840\n",
                        "sustainability  0.173058  0.122766  0.119503\n",
                        "climate         0.201616  0.129706  0.080976\n"
                    ]
                }
            ],
            "source": [
                "topn_topics, topn_topic_scores = embed_analyzer.find_close_topics_to_words(embed_analyzer.topic_vectors, wordlist = 'ewords')\n",
                "\n",
                "print(topn_topics.head())\n",
                "print(topn_topic_scores.head())"
            ]
        },
        {
            "attachments": {},
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "## Find topics for documents"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": 16,
            "metadata": {},
            "outputs": [
                {
                    "name": "stdout",
                    "output_type": "stream",
                    "text": [
                        "Vectors seem not have unit length...the vectors have been l2-normalized.\n"
                    ]
                }
            ],
            "source": [
                "topn_doc_topics, topn_doc_topic_scores = embed_analyzer.find_close_topics_to_docs(doc_vecs, embed_analyzer.topic_vectors)"
            ]
        },
        {
            "attachments": {},
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "With these topics, we can search certain parts of the report for the most common topic and use topic words for increasing the understanding what this part of the reports is mostly about."
            ]
        },
        {
            "cell_type": "code",
            "execution_count": 52,
            "metadata": {},
            "outputs": [
                {
                    "name": "stdout",
                    "output_type": "stream",
                    "text": [
                        "Topic words for the topic wiht the highest count in this report area are:\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "['tariffs' 'protectionist' 'protectionism' 'embargos' 'constrict'\n",
                        " 'instability' 'censorship' 'retaliatory' 'recessions' 'retaliate'\n",
                        " 'hyperinflation' 'nationalism' 'imports' 'expropriation' 'dampen'\n",
                        " 'wavering' 'nationalization' 'austerity' 'overseas' 'calamities'\n",
                        " 'blockages' 'boycotts' 'diplomatic' 'unrest' 'unpredictably']\n",
                        "\n",
                        "Documents which are related in this part of the report read as follows:\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "The Companys business is subject to the risks of international operations.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "The Company derives a significant portion of its revenue and earnings from its international operations.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Compliance with applicable U.S.\n",
                        "and foreign laws and regulations, such as import and export requirements, anti-corruption laws, tax laws, foreign exchange controls and cash repatriation restrictions, data privacy requirements, environmental laws, labor laws, and anti-competition\n",
                        "regulations, increases the costs of doing business in foreign jurisdictions.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "The Company also could be significantly affected by other risks associated with international\n",
                        "activities including, but not limited to, economic and labor conditions, increased duties, taxes and other costs, political instability, and changes in the value of the U.S. dollar versus local currencies.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Margins on sales of the Companys\n",
                        "products in foreign countries, and on sales of products that include components obtained from foreign suppliers, could be materially adversely affected by foreign currency exchange rate fluctuations and by international trade regulations, including\n",
                        "duties, tariffs and antidumping penalties.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "For example, the uncertainty regarding the ability of certain European countries to continue to service their sovereign debt obligations and the related financial restructuring\n",
                        "efforts by European governments may cause the value of several European currencies, including the euro, to fluctuate, which could adversely affect the Companys non-U.S. dollar sales and operating expenses in the impacted jurisdictions.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Weakening of foreign currencies relative to the U.S. dollar adversely affects the U.S. dollar value of the Companys foreign currency-denominated sales and earnings, and generally leads the Company to raise international pricing, potentially\n",
                        "reducing demand for the Companys products.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Conversely, a strengthening of foreign currencies relative to the U.S. dollar, while generally beneficial to the Companys foreign currency-denominated\n",
                        "sales and earnings, could cause the Company to reduce international pricing and incur losses on its foreign currency derivative instruments, thereby limiting the benefit.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "Additionally, strengthening of foreign currencies may also increase the\n",
                        "Companys cost of product components denominated in those currencies, thus adversely affecting gross margins.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "The Companys exposure to credit and collectability risk on its trade receivables is higher in certain international\n",
                        "markets and its ability to mitigate such risks may be limited.\n",
                        "----------------------------------------------------------------------------------------------------\n",
                        "The Company could be impacted by unfavorable results of legal proceedings.\n",
                        "----------------------------------------------------------------------------------------------------\n"
                    ]
                }
            ],
            "source": [
                "doc_idx_start, doc_idx_end = 200, 250\n",
                "\n",
                "top_topic = topn_doc_topics.loc[doc_idx_start:doc_idx_end, 0].value_counts().index[0]\n",
                "print('Topic words for the topic wiht the highest count in this report area are:')\n",
                "print('-'*100)\n",
                "print(embed_analyzer.topic_words[top_topic])\n",
                "print('')\n",
                "mask = topn_doc_topics.loc[doc_idx_start:doc_idx_end, 0] == top_topic\n",
                "corresponding_docids = topn_doc_topics.loc[doc_idx_start:doc_idx_end, 0][mask].index\n",
                "print('Documents which are related in this part of the report read as follows:')\n",
                "print('-'*100)\n",
                "for id in corresponding_docids:\n",
                "    print(report_sentences_preprocessed.loc[docid2idx[id]].raw_text)\n",
                "    print('-'*100)"
            ]
        }
    ],
    "metadata": {
        "kernelspec": {
            "display_name": "fintextanalytics",
            "language": "python",
            "name": "fintextanalytics"
        },
        "language_info": {
            "codemirror_mode": {
                "name": "ipython",
                "version": 3
            },
            "file_extension": ".py",
            "mimetype": "text/x-python",
            "name": "python",
            "nbconvert_exporter": "python",
            "pygments_lexer": "ipython3",
            "version": "3.9.16"
        }
    },
    "nbformat": 4,
    "nbformat_minor": 4
}
